name: "Publish Docs"

on:
  # Auto-trigger this workflow on tag creation
  push:
    tags:
      - 'v*.*.*'
  # Auto-trigger this workflow on merge to main changes in docs/** folder
  pull_request_target:
    types:
      - closed
    branches:
      - main
    paths:
      - 'docs/**'

env:
  RTDS_ADS_PROJECT: https://readthedocs.org/api/v3/projects/accelerated-data-science
  RTDS_ADS_TOKEN: ${{ secrets.RTDS_ADS_TOKEN }}

jobs:
  build-n-publish:
    name: Build and publish Docs üìñ to Readthedocs
    runs-on: ubuntu-latest

    steps:
      - name: When PR ‚úÖ merged - Trigger Readthedocs build
        if: github.event_name == 'pull_request_target' && github.event.pull_request.merged == true
        run: |
          curl \
            -X POST \
            -H "Authorization: Token $RTDS_ADS_TOKEN" $RTDS_ADS_PROJECT/versions/latest/builds/
      - name: When tag üè∑Ô∏è pushed - Trigger Readthedocs build
        if: github.event_name == 'push' && startsWith(github.ref_name, 'v')
        run: |
          # add 10 minutes wait time for readthedocs see freshly created tag
          sleep 10m
          curl \
            -X POST \
            -H "Authorization: Token $RTDS_ADS_TOKEN" $RTDS_ADS_PROJECT/versions/${{ github.ref_name }}/builds/
